y = milk(:,end);
T = length(y);

%% Step 1 - Initial trend estimate
w = [1/24;repmat(1/12,11,1);1/24];
t_hat = conv(y, w, 'same'); 
t_hat(1:6) = t_hat(7); t_hat(T-5:T) = t_hat(T-6); % Endpoint problem

%% Step 2 - Get seasonal indices
s = 12;
sidx = cell(s,1); % Preallocation

for i = 1:s
 sidx{i,1} = i:s:T;
end

%% Step 3 - Preliminary estimate of the seasonality component
SI = y - t_hat;
ws = [1/9, 2/9, 1/3, 2/9, 1/9];
wa = [1/2 7/18 1/9 0 0; 5/18 7/18 2/9 1/9 0];

S = zeros(T,1);
for i = 1:s
    idx = sidx{i};
    S(idx) = mmovw(SI(idx), ws, wa);
end

w = [1/24;repmat(1/12,11,1);1/24];
Ts = conv(S, w, 'same');

Ts(1:6) = Ts(13:18);
Ts(end-5:end) = Ts(end-17:end-12);

S = S-Ts;

%% Step 4 - Preliminary estimate of the adjusted data
TI = y-S;

%% Step 5 - Improved trend estimation

ws = [-0.01934985, -0.02786378,  0.,  0.06549178,  0.14735651, 0.21433675,  0.24005716,  0.21433675,  0.14735651,  0.06549178, 0., -0.02786378, -0.01934985];
wa = [0.42113096  0.35314649  0.2439022   0.11977342  0.01201758 -0.05811026 -0.09186038  0.          0.          0.          0.          0. 0.;
0.2791025   0.29223393  0.25392454  0.17435534  0.07990163  0.00182087 -0.03863188 -0.04270693  0.          0.          0.          0. 0.;
0.14810124  0.21540302  0.24144497  0.21604611  0.14938742  0.06784423 0.002674   -0.02486824 -0.01603276  0.          0.          0. 0.;
0.04483409  0.13024023  0.20076187  0.23002368  0.20784468  0.14440585 0.06608253  0.00413215 -0.02019022 -0.00813488  0.          0. 0.;
-0.01694173  0.05107997  0.13547461  0.20498476  0.23323509  0.2100446 0.14559428  0.06625947  0.0032976  -0.02203625 -0.01099241  0. 0.;
-0.03400878 -0.00532091  0.06099497  0.14368379  0.21148812  0.23803262 0.21313631  0.14698017  0.06593953  0.00127184 -0.02576785 -0.01642982 0.];
   
Trend = mmovw(TI, ws, wa);

%% Step 6 - Final estimate of the seasonality component

SI = y - t_hat;
ws = [0.06666667, 0.13333333, 0.2, 0.2, 0.2, 0.13333333, 0.06666667];
wa = [0.33333333, 0.33333333, 0.26666667, 0.06666667, 0., 0., 0.;
0.26666667, 0.26666667, 0.26666667, 0.13333333, 0.06666667, 0., 0.;
0.15555556, 0.22222222, 0.22222222, 0.2       , 0.13333333, 0.06666667, 0.];

S = zeros(T,1);
for i = 1:s
    idx = sidx{i};
    S(idx) = mmovw(SI(idx), ws, wa);
end

w = [1/24;repmat(1/12,11,1);1/24];
Ts = conv(S, w, 'same');

Ts(1:6) = Ts(13:18);
Ts(end-5:end) = Ts(end-17:end-12);

S = S-Ts; 

%% Step 7 - Preliminary estimate of the adjusted data
TI = y-S;

%% Step 8 - Improved trend estimation
ws = [-0.01934985, -0.02786378,  0.,  0.06549178,  0.14735651, 0.21433675,  0.24005716,  0.21433675,  0.14735651,  0.06549178, 0., -0.02786378, -0.01934985];
wa = [0.42113096  0.35314649  0.2439022   0.11977342  0.01201758 -0.05811026 -0.09186038  0.          0.          0.          0.          0. 0.;
0.2791025   0.29223393  0.25392454  0.17435534  0.07990163  0.00182087 -0.03863188 -0.04270693  0.          0.          0.          0. 0.;
0.14810124  0.21540302  0.24144497  0.21604611  0.14938742  0.06784423 0.002674   -0.02486824 -0.01603276  0.          0.          0. 0.;
0.04483409  0.13024023  0.20076187  0.23002368  0.20784468  0.14440585 0.06608253  0.00413215 -0.02019022 -0.00813488  0.          0. 0.;
-0.01694173  0.05107997  0.13547461  0.20498476  0.23323509  0.2100446 0.14559428  0.06625947  0.0032976  -0.02203625 -0.01099241  0. 0.;
-0.03400878 -0.00532091  0.06099497  0.14368379  0.21148812  0.23803262 0.21313631  0.14698017  0.06593953  0.00127184 -0.02576785 -0.01642982 0.];
   
Trend = mmovw(TI, ws, wa);

figure
plot(Trend)
hold on
plot(y)
hold off


num = 1:length(Trend);
export = [milk(:,1) milk(:,2)  Trend];
writematrix(export, 'datasets_proc/milk.csv');